name: Test ARC Runner

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # Job 1 - Cria artefato inicial (runner managed)
  create-artifact:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Generate file with script.js
        run: |
          echo "ğŸ”¹ Job 1: Creating initial artifact"
          node script.js

      - name: List generated files
        run: |
          echo "ğŸ“ Files created in Job 1:"
          ls -lh file-*.txt || echo "No files found"

      - name: Upload artifact from Job 1
        uses: actions/upload-artifact@v4
        with:
          name: shared-artifacts
          path: file-*.txt
          retention-days: 1

  # Job 2 - Job existente (runner self-hosted) + adiciona mais artefato
  sync:
    runs-on: arc-runner-set
    needs: create-artifact

    steps:
      - name: Download artifact from Job 1
        uses: actions/download-artifact@v4
        with:
          name: shared-artifacts
          path: artifacts-from-job1

      - name: Verify downloaded artifacts
        run: |
          echo "ğŸ“¥ Job 2: Downloaded artifacts from Job 1:"
          ls -lh artifacts-from-job1/
          cat artifacts-from-job1/file-*.txt

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Guard - avoid loop commits
        run: |
          MSG="$(git log -1 --pretty=%B)"
          echo "Last commit message: $MSG"
          if echo "$MSG" | grep -qi "\[n8n-sync\]"; then
            echo "This is an automation commit. Skipping."
            exit 0
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Sync projects
        env:
          N8N_BASE_URL: ${{ secrets.N8N_BASE_URL }}
          N8N_AUTH_COOKIE: ${{ secrets.TESTE_SECRET }}

          TARGET_WORKFLOWS_DIR: "workflows"

          BEFORE_SHA: ${{ github.event.before }}
          AFTER_SHA:  ${{ github.sha }}
        run: |
          node --version
          node script.js

      - name: Create additional file in Job 2
        run: |
          echo "ğŸ”¹ Job 2: Creating additional artifact"
          node -e "
            const fs = require('fs');
            const crypto = require('crypto');
            const hash = crypto.randomBytes(8).toString('hex');
            const fileName = \`file-job2-\${hash}.txt\`;
            const content = \`Generated in Job 2
            Hash: \${hash}
            Timestamp: \${new Date().toISOString()}
            This file was created in the self-hosted runner
            \`;
            fs.writeFileSync(fileName, content);
            console.log('âœ… File created in Job 2:', fileName);
          "

      - name: Combine artifacts
        run: |
          echo "ğŸ“¦ Combining artifacts from Job 1 and Job 2"
          mkdir -p combined-artifacts
          cp artifacts-from-job1/file-*.txt combined-artifacts/ 2>/dev/null || true
          cp file-*.txt combined-artifacts/ 2>/dev/null || true
          echo "ğŸ“ Combined artifacts:"
          ls -lh combined-artifacts/

      - name: Upload combined artifacts
        uses: actions/upload-artifact@v4
        with:
          name: shared-artifacts
          path: combined-artifacts/
          retention-days: 1
          overwrite: true

      - name: Commit & push (if changes)
        run: |
          if git status --porcelain | grep .; then
            git config user.name  "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore: sync n8n workflows by project [n8n-sync]"
            git push
          else
            echo "No changes to commit."
          fi

  # Job 3 - Valida artefatos (runner managed)
  verify-artifact:
    runs-on: ubuntu-latest
    needs: sync

    steps:
      - name: Download final artifacts
        uses: actions/download-artifact@v4
        with:
          name: shared-artifacts
          path: final-artifacts

      - name: Verify and validate artifacts
        run: |
          echo "âœ… Job 3: Validating final artifacts"
          echo ""
          echo "ğŸ“ All artifacts received:"
          ls -lh final-artifacts/
          echo ""
          echo "ğŸ“Š Total files: $(ls final-artifacts/ | wc -l)"
          echo ""
          echo "ğŸ“„ Content of each file:"
          echo "================================"
          for file in final-artifacts/file-*.txt; do
            if [ -f "$file" ]; then
              echo ""
              echo "--- $(basename $file) ---"
              cat "$file"
            fi
          done
          echo ""
          echo "================================"
          echo "âœ… Validation complete!"
          echo ""
          echo "ğŸ¯ Summary:"
          echo "  - Job 1 (ubuntu-latest): Created initial file(s)"
          echo "  - Job 2 (arc-runner-set): Added additional file(s)"
          echo "  - Job 3 (ubuntu-latest): Successfully received all artifacts"
